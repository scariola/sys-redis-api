<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core"
	xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/dw http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd">
	<configuration doc:name="Configuration"
		doc:id="4bd673a3-36c0-4ae3-b6ad-20cb88633db2"
		defaultErrorHandler-ref="sys-redis-api_Shared_Error_Handler" />
	<flow name="get-redis-cache-flow"
		doc:id="de072993-872c-4d0f-ac57-51dd3ead9d16">
		<flow-ref doc:name="get-redis-cache"
			doc:id="cdd05ae3-464b-46cf-a86a-f47d57d06384" name="get-redis-cache" />
		<choice doc:name="Choice"
			doc:id="6b936c47-7da7-4cda-8d9b-da0021d6a7de">
			<when expression="#[sizeOf(payload) &gt; 0]">
				<ee:transform doc:name="Transform Message"
					doc:id="e7db7c62-7c05-42e3-bf55-5749819faf58">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
var result = read(payload,'application/json')
---
{
  "x-event-code": 1005,
  "x-event-msg": "Success",
  "Results": result
}
]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise>
				<logger level="INFO" doc:name="Logger"
					doc:id="6e87eaa9-bc23-4674-8989-7d3fafb34361"
					message="Redis key not exist!" />
				<raise-error doc:name="REDIS:KEY_NOT_FOUND"
					doc:id="6f40a5fc-b0af-4f37-839b-d097dfab06bd"
					type="REDIS:KEY_NOT_FOUND" />
			</otherwise>
		</choice>
	<on-error-continue type="REDIS:KEY_NOT_FOUND"
			logException="false" enableNotifications="true">
			<ee:transform>
				<ee:message>
					<ee:set-payload resource="dw/redis-not-found.dwl" />
				</ee:message>
			</ee:transform>
			<set-variable variableName="httpStatus" value="404" />
		</on-error-continue>


	</flow>
	<flow name="create-update-redis-cache-flow"
		doc:id="52457c54-4ba0-40d1-b6b7-a1ef9df601de">
		<flow-ref doc:name="get-redis-cache"
			doc:id="3348da45-6c12-4998-bfed-bf97b4de97e9" name="set-redis-cache" />
		<choice doc:name="Choice"
			doc:id="900c282a-2e54-4acf-8712-99b8336378b5">
			<when expression="#[payload == 'OK']">
				<ee:transform doc:name="Transform Message"
					doc:id="08f38691-cf56-436c-8e97-8d6765865e29">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
{
 "x-event-code": 1002,
 "x-event-msg": "Cache Bridge Successful!"
}]]></ee:set-payload>
					</ee:message>
				</ee:transform>
			</when>
			<otherwise>
				<logger level="INFO" doc:name="Logger"
					doc:id="674e065b-482b-4baf-ac15-09a0dcd3fe12"
					message="Failed to Update!" />
				<raise-error doc:name="REDIS:CONNECTIVITY"
					doc:id="669ed14d-d08d-43d2-925f-8b7b87c68bdf"
					type="REDIS:CONNECTIVITY" />
			</otherwise>
		</choice>
				<on-error-propagate type="REDIS:CONNECTIVITY"
			logException="false" enableNotifications="true">
			<ee:transform>
				<ee:message>
					<ee:set-payload resource="dw/redis-connection-failed.dwl" />
				</ee:message>
			</ee:transform>
			<set-variable variableName="httpStatus" value="500" />
		</on-error-propagate>

	</flow>

</mule>
